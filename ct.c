#include "Pre.h"
#define C 0
float alpha_[] = {0, 1.32371, 1.2591, 1.21359, 1.17728, 1.14658, 1.11967, 1.09547, 1.07347, 1.05326, 1.03436, 1.01666, 1.00005, 0.984251, 0.969248, 0.954846, 0.941044, 0.927842, 0.915139, 0.902837, 0.890935, 0.879434, 0.868232, 0.85743, 0.846828, 0.836526, 0.826525, 0.816723, 0.807122, 0.79772, 0.788619, 0.779617, 0.770816, 0.762214, 0.753713, 0.745411, 0.73721, 0.729209, 0.721307, 0.713506, 0.705905, 0.698304, 0.690902, 0.683601, 0.6764, 0.669299, 0.662198, 0.655296, 0.648495, 0.641694, 0.634993, 0.628392, 0.621891, 0.61549, 0.609089, 0.602788, 0.596587, 0.590386, 0.584285, 0.578184, 0.572283, 0.566282, 0.560481, 0.55458, 0.548879, 0.543178, 0.537477, 0.531876, 0.526375, 0.520774, 0.515373, 0.509972, 0.504571, 0.499171, 0.493971, 0.488672, 0.483473, 0.478273, 0.473174, 0.468075, 0.462976, 0.457976, 0.452977, 0.447977, 0.443078, 0.438179, 0.433379, 0.42848, 0.423681, 0.418981, 0.414182, 0.409483, 0.404783, 0.400184, 0.395584, 0.390985, 0.386386, 0.381886, 0.377287, 0.372787, 0.368388, 0.363889, 0.359489, 0.35509, 0.35069, 0.346391, 0.341991, 0.337692, 0.333393, 0.329193, 0.324894, 0.320694, 0.316495, 0.312295, 0.308196, 0.303997, 0.299897, 0.295798, 0.291698, 0.287599, 0.283599, 0.2795, 0.2755, 0.271501, 0.267501, 0.263502, 0.259602, 0.255603, 0.251703, 0.247804, 0.243904, 0.240103, 0.236203, 0.232303, 0.228503, 0.224703, 0.220903, 0.217103, 0.213303, 0.209603, 0.205803, 0.202103, 0.198403, 0.194703, 0.191003, 0.187303, 0.183603, 0.179902, 0.176302, 0.172702, 0.169002, 0.165402, 0.161802, 0.158202, 0.154602, 0.151102, 0.147502, 0.144002, 0.140402, 0.136902, 0.133402, 0.129902, 0.126402, 0.122902, 0.119401, 0.116001, 0.112501, 0.109101, 0.105601, 0.102201, 0.0988011, 0.095401, 0.092001, 0.0886009, 0.0852009, 0.0818008, 0.0785008, 0.0751007, 0.0718006, 0.0684006, 0.0651005, 0.0618005, 0.0585004, 0.0552004, 0.0519003, 0.0486002, 0.0453002, 0.0420001, 0.0387001, 0.0355, 0.0322, 0.029, 0.0257, 0.0225, 0.0193, 0.016, 0.0128, 0.00959999, 0.0064, 0.0032, 0.0001};
float max_d[] = {0, 0.271609, 0.429403, 0.560777, 0.677105, 0.783175, 0.881825, 0.974896, 1.06295, 1.1466, 1.22719, 1.3048, 1.37929, 1.45167, 1.52167, 1.59, 1.65665, 1.72116, 1.78419, 1.84604, 1.90637, 1.96542, 2.02347, 2.07995, 2.13597, 2.19065, 2.24429, 2.29718, 2.34929, 2.40059, 2.45054, 2.50031, 2.5492, 2.59718, 2.64476, 2.6914, 2.73777, 2.78299, 2.82793, 2.87238, 2.91583, 2.95947, 3.00209, 3.04401, 3.08559, 3.1268, 3.16783, 3.20796, 3.24753, 3.28707, 3.32605, 3.36463, 3.40247, 3.43991, 3.47728, 3.51423, 3.55044, 3.58673, 3.62243, 3.65822, 3.69273, 3.72782, 3.76164, 3.7962, 3.82949, 3.86284, 3.89608, 3.92871, 3.96074, 3.99347, 4.02477, 4.05612, 4.08751, 4.11877, 4.14893, 4.17945, 4.20952, 4.23946, 4.26878, 4.29797, 4.32717, 4.35577, 4.38422, 4.41269, 4.44054, 4.46825, 4.49535, 4.52306, 4.55002, 4.57637, 4.60331, 4.6295, 4.65568, 4.68112, 4.70654, 4.73195, 4.75719, 4.78184, 4.80703, 4.83149, 4.85535, 4.87975, 4.90342, 4.92705, 4.95051, 4.97352, 4.99676, 5.01955, 5.04217, 5.06413, 5.08656, 5.10842, 5.13022, 5.15183, 5.17288, 5.19424, 5.21504, 5.23577, 5.25643, 5.27701, 5.29692, 5.31722, 5.33697, 5.35652, 5.37599, 5.39536, 5.41419, 5.43337, 5.4519, 5.47044, 5.48877, 5.50657, 5.52468, 5.54268, 5.56015, 5.5774, 5.59463, 5.61174, 5.62862, 5.64509, 5.6618, 5.6779, 5.69396, 5.70979, 5.72556, 5.74126, 5.75673, 5.77211, 5.78692, 5.80165, 5.81661, 5.83108, 5.84537, 5.85947, 5.87355, 5.88699, 5.90075, 5.91395, 5.92737, 5.9403, 5.9531, 5.96567, 5.97816, 5.99047, 6.00261, 6.01428, 6.02611, 6.03741, 6.04895, 6.05996, 6.07075, 6.08142, 6.09195, 6.10224, 6.11237, 6.12232, 6.13178, 6.14134, 6.15044, 6.15961, 6.16828, 6.1768, 6.18508, 6.19312, 6.20097, 6.20857, 6.21593, 6.22303, 6.2299, 6.23628, 6.24258, 6.24842, 6.2541, 6.25931, 6.26416, 6.26878, 6.27284, 6.27643, 6.27949, 6.28187, 6.28318};
float t_[] = {0, 0.742711, 0.938143, 1.07627, 1.18678, 1.2805, 1.36291, 1.43723, 1.50494, 1.56725, 1.62566, 1.68057, 1.73217, 1.78138, 1.82819, 1.8732, 1.91651, 1.95791, 1.99792, 2.03678, 2.07434, 2.11081, 2.14637, 2.18073, 2.2146, 2.24747, 2.27953, 2.311, 2.34187, 2.37214, 2.40151, 2.43068, 2.45925, 2.48722, 2.51489, 2.54196, 2.56884, 2.59501, 2.62098, 2.64666, 2.67173, 2.6969, 2.72148, 2.74565, 2.76963, 2.7934, 2.81708, 2.84026, 2.86313, 2.88601, 2.90859, 2.93096, 2.95294, 2.97472, 2.9965, 3.01807, 3.03925, 3.06053, 3.08151, 3.10259, 3.12297, 3.14374, 3.16382, 3.1844, 3.20428, 3.22426, 3.24424, 3.26392, 3.2833, 3.30318, 3.32226, 3.34144, 3.36072, 3.38, 3.39868, 3.41766, 3.43644, 3.45522, 3.47371, 3.49219, 3.51077, 3.52905, 3.54733, 3.56571, 3.58379, 3.60187, 3.61966, 3.63794, 3.65582, 3.6734, 3.69148, 3.70916, 3.72695, 3.74433, 3.76181, 3.77939, 3.79697, 3.81426, 3.83204, 3.84942, 3.8665, 3.88408, 3.90127, 3.91855, 3.93583, 3.95291, 3.9703, 3.98748, 4.00467, 4.02149, 4.03882, 4.05584, 4.07296, 4.09009, 4.10691, 4.12413, 4.14106, 4.15808, 4.1752, 4.19243, 4.20925, 4.22657, 4.2436, 4.26062, 4.27774, 4.29496, 4.31189, 4.32931, 4.34633, 4.36356, 4.38078, 4.3977, 4.41513, 4.43265, 4.44987, 4.4671, 4.48452, 4.50205, 4.51957, 4.53689, 4.55472, 4.57214, 4.58976, 4.60739, 4.62521, 4.64324, 4.66126, 4.67949, 4.69731, 4.71533, 4.73396, 4.75229, 4.77071, 4.78924, 4.80806, 4.82639, 4.84551, 4.86424, 4.88366, 4.90279, 4.92212, 4.94154, 4.96127, 4.9812, 5.00132, 5.02115, 5.04178, 5.06201, 5.08323, 5.10406, 5.12509, 5.14652, 5.16835, 5.19038, 5.21281, 5.23564, 5.25817, 5.2818, 5.30523, 5.32987, 5.3542, 5.37924, 5.40477, 5.43091, 5.45784, 5.48548, 5.51402, 5.54346, 5.5741, 5.60484, 5.63799, 5.67173, 5.70828, 5.74603, 5.78629, 5.83145, 5.87971, 5.93419, 5.99868, 6.08229, 6.24701};
void update_pos(robot *r, float angel, float dis)
{
	static float start_time[NUM] = {0};
	r->pr.x += dis * cos(angel);
	r->pr.y += dis * sin(angel);
}
void ct(robot *r, table *t)
{
	static char flag_initial[NUM] = {0}; /// the arrays help to initial the OMEGA and Time;
	static float last_angel[NUM] = {0};
	static float last_time[NUM] = {0};
	static int find[NUM] = {0};
	float dis;
	static float current_x[NUM] = {0};
	static float current_y[NUM] = {0};
	float a = 0.01 / M_R ;
	static char ii = 0;
	if(r->pub.num == 0)
	{
		///*********************initial, using omega * r = delta_phi, get the angel_velocity********************************8
		if(flag_initial[r->pub.num] < 3)
		{
			
			if(r->time <= 0.3)/// get the omega
			{
				if(flag_initial[r->pub.num] == 0)
				{
					last_angel[r->pub.num] = atan2(r->s.ay, r->s.ax);
					flag_initial[r->pub.num] = 1;
					last_time[r->pub.num] = r->time;
				}
				else
				{
					float temp = atan2(r->s.ay, r->s.ax);
					r->pr.omega += (temp - last_angel[r->pub.num]) / (r->time - last_time[r->pub.num]);
					r->pr.omega /= flag_initial[r->pub.num];
					last_angel[r->pub.num] = temp;
					last_time[r->pub.num] = r->time;
					flag_initial[r->pub.num] = 2;
				}
				
			}
			else
			{
				flag_initial[r->pub.num] = 4;
				r->pr.rotate = r->pr.omega * r->time  + Pi - atan2(r->s.ay, r->s.ax);
				if(r->pr.rotate > Pi)
					r->pr.rotate -= 2 * Pi;
				if(r->pr.rotate < -Pi)
					r->pr.rotate += 2 * Pi;
				r->pr.rotate_initial = r->pr.rotate;
				r->time_ = r->time;
				//printf("%f",r->angel);
			}
		}///*********************initial, using omega * r = delta_phi, get the angel_velocity********************************
		else
		{
			float theta = r->time * r->pr.omega;
			float start, end;
			float dis_x, dis_y;/// the desire point in the robot frame.
			float v_angel;
			dis_x = XX[ii];
			dis_y = YY[ii];
			find[r->pub.num] = (int)(a / 0.01 + 0.5);
			dis = sqrt(fabs((dis_x - r->x + t->x) * (dis_x - r->x + t->x) + (dis_y - r->y + t->y) * (dis_y - r->y + t->y)));///.....................................
			if (dis < max_d[find[r->pub.num]] * M_R )
			{
				int i = 0;
				for(i =find[r->pub.num];;)
				{
					if (max_d[i] * M_R <= dis)
						break;
					else
						i--;
				}
				find[r->pub.num] = i;
			}
			r->m_o = atan2((dis_y - r->y + t->y), (dis_x - r->x + t->x)) - r->pr.rotate;///...................................
			v_angel = r->time * (r->pr.omega) + Pi / 2;
			
			if(v_angel > Pi)
				v_angel -= 2 * Pi;
			if(v_angel < -Pi)
				v_angel += 2 * Pi;
			start = r->m_o + alpha_[find[r->pub.num]] + r->pr.rotate;
			end  = start + t_[find[r->pub.num]];
			if(start > Pi)
				start -= 2 * Pi;
			if(start < -Pi)
				start += 2 * Pi;
			if(end > Pi)
				end-= 2 * Pi;
			if(end < -Pi)
				end += 2 * Pi;
			r->pr.v_angel = start;
			if (dis < 0.28 * M_R)
			{	
				r->is_on = 1;
				r->pr.x = current_x[r->pub.num];
				r->pr.y = current_y[r->pub.num];
				ii ++;
				flag_initial[r->pub.num] = 4;
				if(ii>8)
					ii = 8;
				r->time_ = r->time;
				//flag ^= 1;
				//if(flag == 1)
				//printf("%f, %d\n ", r->x - t->x - current_x[r->pub.num], flag);
				return ;				
			}
			if(r->is_on == 0)///**************************
			{
				float xt, yt;
				float time;
				if(r->time < r->time_)
					time = r->time + 2 * Pi / r->pr.omega;
				else
					time = r->time;
				xt = M_R * cos(r->time * r->pr.omega);
				yt = M_R * sin(r->time * r->pr.omega);
				current_x[r->pub.num] = -xt + M_R * cos(r->time_ * r->pr.omega) + r->pr.omega * (time - r->time_) * M_R * cos(r->pr.v_angel) + r->pr.x;
				current_y[r->pub.num] = -yt + M_R * sin(r->time_ * r->pr.omega) + r->pr.omega * (time - r->time_) * M_R * sin(r->pr.v_angel) + r->pr.y;
				flag_initial[r->pub.num] = 4;/// Make prepare for the next update.
			    ///***************The control program start from here
			}
			else///**********************************************************
			{
				r->time_ = r->time;
				if(flag_initial[r->pub.num] < 6)
				{
					if(1)/// ************************update the omega and roate.
					{
						if(flag_initial[r->pub.num] == 4)
						{
							last_angel[r->pub.num] = atan2(r->s.ay, r->s.ax);
							flag_initial[r->pub.num] = 5;
							last_time[r->pub.num] = r->time;
							//update_pos(r, r->m_o + (r->pr.rotate), max_d[find[r->pub.num]] * M_R);///***********update the position in robot's frame	
							r->pr.x = current_x[r->pub.num];
							r->pr.y = current_y[r->pub.num];
						}
						else
						{
							float temp = atan2(r->s.ay, r->s.ax);
							//r->pr.omega = ((temp - last_angel[r->pub.num]) / (r->time - last_time[r->pub.num]) + r->pr.omega) / 2;
							/// can't update the omega while motion.
							last_angel[r->pub.num] = temp;
							last_time[r->pub.num] = r->time;
							flag_initial[r->pub.num] = 5;
							r->pr.rotate = r->pr.omega * r->time  + Pi - atan2(r->s.ay, r->s.ax);
							if(r->pr.rotate > Pi)
								r->pr.rotate -= 2 * Pi;
							if(r->pr.rotate < -Pi)
								r->pr.rotate += 2 * Pi;
                         ///**********this is part is good to go.
						}
					}
					else
					{
						flag_initial[r->pub.num] = 6;
						r->pr.rotate = (r->pr.omega) * (r->time)  + Pi - atan2(r->s.ay, r->s.ax);
						if(r->pr.rotate > Pi)
							r->pr.rotate -= 2 * Pi;
						if(r->pr.rotate < -Pi)
							r->pr.rotate += 2 * Pi;
					}
				}
			}
			///**********The control program start from here

			if(start <= end)
			{
				if(start < v_angel && v_angel < end)
						r->is_on = 0;
				else
						r->is_on = 1;
				}
			else
			{
				if(start < v_angel || v_angel < end)
					r->is_on = 0;
				else
					r->is_on = 1;
			}
				//printf("%f, %f, %d\n",r->y - t->y - current_y[r->pub.num], r->x  - t->x - current_x[r->pub.num], ii);
		}
	}
}